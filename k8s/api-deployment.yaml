---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: api
spec:
  replicas: 1
  template:
    metadata:
      annotations:
        alpha.image.policy.openshift.io/resolve-names: '*'
      labels:
        service: api
    spec:
      containers:
        - name: api
          image: havengrc-docker.jfrog.io/postgrest/postgrest:latest
          env:
            - name: PGRST_DB_URI
              value: "postgres://${DATABASE_USERNAME}:${DATABASE_PASSWORD}@db/havenstage"
            - name: DATABASE_HOST
              value: "db"
            - name: PGRST_DB_SCHEMA
              value: "1"
            - name: DATABASE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: haven-database-credentials
                  key: username
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: haven-database-credentials
                  key: password
            - name: PGRST_JWT_AUD
              value: "havendev"
            - name: PGRST_JWT_SECRET
              value: "@/etc/haven-credentials/jwk.json"
            - name: PGRST_SERVER_PORT
              value: "80"
            - name: PGRST_SERVER_PROXY_URI
              value: "https://staging.havengrc.com/api"
            - name: PGRST_DB_POOL
              value: "10"
          volumeMounts:
            - name: secret-volume
              mountPath: /etc/haven-credentials/
              readOnly: true
          ports:
            - containerPort: 3001
              protocol: TCP
              targetPort: 80
      volumes:
        - name: secret-volume
          secret:
            secretName: haven-database-credentials
      restartPolicy: Always
  strategy:
    type: "Recreate"
  paused: false
  revisionHistoryLimit: 2
  minReadySeconds: 0
status: {}
